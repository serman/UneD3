/* Data viz by Sergio Galán http://sergio.eclectico.net Alfredo Calosci.  for UNED. Magic By D3js.org */function setSizes(){viewportWidth=$(window).width(),viewportHeight=$(window).height(),viewmode="desktop",viewmode_sub="",availableHeight=viewportHeight-18-100,canvasWidth=viewportWidth-20,diameter=Math.max(availableHeight,720),diameter=Math.min(diameter,850),canvasHeight=diameter+20,radius=diameter/2,clusterSize=radius,leftOffset=Math.max(100,canvasWidth-diameter-500),leftOffset=Math.min(leftOffset,300),translatePositionX=clusterSize+leftOffset,translatePositionY=canvasHeight>availableHeight?availableHeight/2+5:clusterSize+5,tagRadiusWeight=110,tagRadius=clusterSize-tagRadiusWeight,areaPosition=130,769>viewportWidth&&(viewmode="mobile",availableHeight=viewportHeight-60,diameter=Math.max(availableHeight,640),diameter=Math.min(diameter,800),canvasHeight=availableHeight,radius=diameter/2,clusterSize=radius,tagRadiusWeight=110,tagRadius=clusterSize-tagRadiusWeight,areaPosition=130,translatePositionX=-tagRadius+20),viewportWidth>768&&1280>viewportWidth&&(viewmode_sub="middleSize")}function reload(){$("#canvas-container").empty(),setSizes(),doeverything(),$("#search").val("")}function doeverything(){0==initHelpTransition&&(start_course_animation/=4,change_text_help2/=4,start_course_text_animation/=4,change_text_help3/=4,start_tags_animation/=4),svg=d3.select("#canvas-container").append("svg").attr("width",canvasWidth).attr("height",canvasHeight).append("g").attr("transform","translate("+translatePositionX+","+translatePositionY+")"),helphoverContainer=svg.append("g").classed("helphoverContainer",!0),backgroundContainer=svg.append("g").classed("backgroundContainer",!0),tagLinkContainer=svg.append("g").classed("tagLinkContainer",!0),courseLinkContainer=svg.append("g").classed("courseLinkContainer",!0),tagContainer=svg.append("g").classed("tagContainer",!0).call(zoom),courseContainer=svg.append("g").classed("courseContainer",!0).call(zoomCursos),backgroundContainer.append("rect").attr("x","-50%").attr("y","-50%").attr("width","100%").attr("height","100%").classed("backgroundRect",!0),backgroundContainer.append("circle").attr("cx",0).attr("cx",0).attr("r",diameter).classed("courseCircle",!0).call(zoomCursos).transition().delay(start_course_text_animation+1e3).duration(1e3).style("opacity",1),backgroundContainer.append("circle").attr("cx",0).attr("cx",0).attr("r",tagRadius+tagRadiusWeight).classed("tagCircle",!0).call(zoom).transition().delay(change_text_help3).duration(1e3).style("opacity",1),backgroundContainer.append("circle").attr("cx",0).attr("cx",0).attr("r",tagRadius-20).classed("areaCircle",!0).transition().delay(start_course_text_animation+1e3).duration(1e3).style("opacity",1),showHelpCircles(),d3.json(filename,function(error,root){if(error)throw error;newRoot=preprocessJson(root);var t=getTags(root);for(tagsDict=t.diccio,tagsList=t.arr,cluster=d3.layout.cluster().size([360,clusterSize]),nodes=cluster.nodes(newRoot),i=0;i<nodes.length;i++)nodes[i].order=i;createNodeCursos(),updateLinksAreasCursos(4e3,start_course_animation,"elastic"),asignTagPosition(),updateNodesTags(2e3,start_tags_animation),linksTags=linkNodeTag(tagsDict,nodes),updateLinksTags(5e3,start_tags_animation+1e3),svg.selectAll("g.node.area:not(.cat-home)").on("click",function(d){clearTimeout(timerAutoRotate),areaCentric(d)}),courseContainer.selectAll("g.node:not(.area):not(.clicked)").on("click",function(d){if(1==d3.select(this).classed("clicked"))cursoCentric(d,this),clearTimeout(timerAutoRotate);else{moveLeftIfNeeded(),"zoomout"==mode&&areaCentric(d.parent),courseContainer.selectAll(".clicked").classed("clicked",!1),$("#messages > #cat").removeClass(),$("#messages > #cat").addClass("area-"+d.parent.slug),d3.select(this).classed("clicked",!0),$("#messages").show().css("z-index","10"),$("#messages #titulo span").empty().text(d.titulo),$("#messages #course-link").attr("href",d.url),$("#messages #course-center").data("courseObject",d),$("#messages #course-center").data("courseNode",this),$("#messages #category-list").empty().text(d.categoria),$("#messages #category-list").data("category",d.parent);for(var taglist="",i=0;i<d.tags.length;i++)taglist+='<a href="#" data-tag="'+d.tags[i]+'">'+d.tags[i]+"</a>";$("#messages #tag-list").empty().html(taglist),0!=d.fecha_inicio?($("#messages #fecha-inicio").text(d.fecha_inicio),0!=d.fecha_fin?$("#messages #fecha-fin").text(" - "+d.fecha_fin):$("#messages #fecha-fin").text(" - permanente")):($("#messages #fecha-inicio").text("próximamente"),$("#messages #fecha-fin").text(""))}}),svg.selectAll("g.node.cat-home").on("click",function(d){("areacentric"!=mode||"zoomout"!=mode)&&(mode="zoomout",cleanTagSelections(),d3.select(this).style("opacity",0),nodes=cluster.nodes(newRoot),updateCoursesWithRotation(void 0,1500),updateLinksAreasCursos(),updateLinksTags()),svg.transition().delay(500).duration(1e3).attr("transform","translate("+translatePositionX+","+translatePositionY+")")}),svg.selectAll("g.tag").on("mouseover",function(d){tagLinkContainer.selectAll("path.linktag.tag-"+d.slug).classed("selected",!0).each(updateNodeStyleTagSelected("nouso",!0))}).on("mouseout",function(d){tagLinkContainer.selectAll("path.linktag.tag-"+d.slug).classed("selected",!1).each(updateNodeStyleTagSelected("nouso",!1))}),svg.selectAll("g.tag").on("click",function(d){clearTimeout(timerAutoRotate),tagCentric(d,this)}),svg.selectAll("g.node.area").on("mouseover",function(d){courseLinkContainer.selectAll("path.link.source-"+d.slug).classed("mouseHoverArea",!0),courseContainer.selectAll("g.node.area-"+d.slug).classed("mouseHoverArea",!0)}).on("mouseout",function(d){courseLinkContainer.selectAll("path.link.source-"+d.slug).classed("mouseHoverArea",!1),courseContainer.selectAll("g.node.area-"+d.slug).classed("mouseHoverArea",!1)}),svg.selectAll("g.node:not(.area)").on("mouseover",function(d){courseLinkContainer.selectAll("path.link.target-"+d.slug).classed("mouseHoverArea",!0),tagLinkContainer.selectAll("path.linktag.course-"+d.slug).classed("selected",!0).each(function(d){tagContainer.select("g.tag-"+d.tag.slug).classed("relevant",!0)})}).on("mouseout",function(d){courseLinkContainer.selectAll("path.link.target-"+d.slug).classed("mouseHoverArea",!1),tagLinkContainer.selectAll("path.linktag.course-"+d.slug).classed("selected",!1).each(function(d){tagContainer.select("g.tag-"+d.tag.slug).classed("relevant",!1)})})})}function updateNodeStyleTagSelected(name,value){return function(d){svg.selectAll(".node.tag-"+d.tag.slug).classed("tagSelected",value)}}function tagCentric(tagObject,tagNode){cleanTagSelections(),zoomed(),d3.selectAll([tagNode]).classed("selectedTagCentric",!0),mode="tagcentric";var d=tagObject,relatedC=getRelatedCoursesTC(d);centerTagRepositionCourses(d),tagLinkContainer.selectAll("path.linktag.tag-"+d.slug).classed("selectedCC",!0),updateNodesTags(),repositionNodesCC(relatedC),updateNodeCursosCCMode(),updateLinksAreasCursos(),updateLinksTags()}function cursoCentric(_course,_coursedom){cleanTagSelections(),zoomed(),mode="cursocentric",d3.select(_coursedom).classed("cursocentrico",!0),$("select#area-select").val(_course.parent.slug),$("#messages > #cat").removeClass(),$("#messages > #cat").addClass("area-"+_course.parent.slug);var relatedcourses2=getRelatedCoursesCC(_course);repositionNodesCC(relatedcourses2,_course),updateNodeCursosCCMode(_course),updateLinksAreasCursos(),reOrderTagsCC(_course),updateNodesTags(),updateLinksTags(),updateSelectedLinksTagsCC(_course)}function areaCentric(_d){"areacentric"!==mode?(mode="areacentric",autoRotateTags()):mode="areacentric",cleanTagSelections(),nodes=cluster.nodes(newRoot),updateCoursesWithRotation(-(_d.x-90),1e3),zoomed(),updateLinksAreasCursos(),updateLinksTags(2e3),courseLinkContainer.selectAll("path.link.source-"+_d.slug).classed("areacentricSelected",!0),courseContainer.selectAll("g.node.area-"+_d.slug).classed("areacentricSelected",!0),$("select#area-select").val(_d.slug),$("#messages > #cat").removeClass(),$("#messages > #cat").addClass("area-"+_d.slug)}function zoomed(){return"mobile"==viewmode?void centerMobilePosition():(myZoom=1.3,myTranslate[0]=20,myTranslate[1]=translatePositionY,void svg.transition().delay(400).duration(1e3).attr("transform","translate("+myTranslate+")scale("+myZoom+")"))}function centerMobilePosition(){"mobile"==viewmode&&(768==viewportWidth&&viewportHeight>=900&&1024>viewportHeight?(svg.transition().delay(100).duration(1e3).attr("transform","translate("+translatePositionX+","+translatePositionY+"),scale(1.3)"),$("#move-left").show()):(svg.transition().delay(100).duration(1e3).attr("transform","translate("+translatePositionX+","+translatePositionY+")"),$("#move-left").show()))}function moveLeftIfNeeded(){"middleSize"==viewmode_sub&&(svg.transition().delay(100).duration(1e3).attr("transform","translate(-100,"+translatePositionY+"),scale("+myZoom+")"),$("#move-left").show())}function autoRotateCoursesUP(){updateCoursesWithRotation(-5),updateLinksAreasCursos(),timerRotateCourses=setTimeout(autoRotateCoursesUP,50)}function autoRotateCoursesDOWN(){updateCoursesWithRotation(5),updateLinksAreasCursos(),timerRotateCourses=setTimeout(autoRotateCoursesDOWN,50)}function autoRotateTags(){var d1=tagsList[1];centerTagRepositionCourses(d1),updateNodesTags(),updateLinksTags(1e3),"areacentric"===mode&&(timerAutoRotate=setTimeout(autoRotateTags,6e3))}function blink1(){var circle1=d3.select(this).select("circle");!function repeat(){var color1;color1=null==circle1[0][0]?"black":circle1.style("fill"),circle1.transition().delay(2e3).duration(randomIntFromInterval(300,500)).style("fill","white").transition().duration(randomIntFromInterval(300,500)).style("fill",color1).each("end",repeat)}()}function jump1(){var circle1=d3.select(this).select("circle, path, rect");d3.select(this);!function repeat(){circle1.y;circle1.transition().delay(randomIntFromInterval(500,1e3)).duration(randomIntFromInterval(200,400)).ease("bounce").attr("transform","translate(5,5)").transition().duration(200).ease("bounce").attr("transform","translate(0,0)").each("end",repeat)}()}function scale1(){var circle1=d3.select(this).select("circle, path, rect");d3.select(this);!function repeat(){circle1.y;circle1.transition().delay(randomIntFromInterval(2500,3500)).duration(randomIntFromInterval(600,1e3)).ease("bounce").attr("transform","scale(2)").transition().duration(800).ease("bounce").attr("transform","scale(1)").each("end",repeat)}()}function zoomScrollCursos(){if(evento1=d3.event.sourceEvent,"zoom"==d3.event.type&&d3.event.sourceEvent instanceof WheelEvent){var scaleFunc,incremento=(tagsList.length,d3.event.scale),num_items=0;scaleFunc=1>incremento?d3.scale.linear().domain([1,0]).range([1,20]).clamp(!0):d3.scale.linear().domain([2,1]).range([-20,-1]).clamp(!0);var num_items=-Math.round(scaleFunc(d3.event.scale));updateCoursesWithRotation(num_items),zoomCursos.scale(1)}else if("zoom"==d3.event.type&&(d3.event.sourceEvent instanceof MouseEvent||d3.event.sourceEvent instanceof TouchEvent)){var incremento=0;incremento=d3.event.sourceEvent instanceof MouseEvent?-d3.event.sourceEvent.movementY:previousPageY-d3.event.sourceEvent.touches[0].pageY;var scaleFunc;scaleFunc=0>incremento?d3.scale.linear().domain([-1,-60]).range([2,10]).clamp(!0):d3.scale.linear().domain([1,60]).range([-2,-10]).clamp(!0);var num_items=scaleFunc(incremento);num_items=Math.round(num_items),updateCoursesWithRotation(num_items),zoomCursos.translate([0,0]),d3.event.sourceEvent instanceof TouchEvent&&(previousPageY=d3.event.sourceEvent.touches[0].pageY)}}function zoomScrollCursosEnd(){zoomCursos.translate([0,0]),updateLinksTags(2e3),updateLinksAreasCursos(500)}function zoomScrollCursosStart(){d3.event.sourceEvent instanceof TouchEvent&&(previousPageY=d3.event.sourceEvent.touches[0].pageY)}function zoomScrollTags(){if(evento1=d3.event.sourceEvent,"zoom"==d3.event.type&&d3.event.sourceEvent instanceof WheelEvent){var scaleFunc,lngth=tagsList.length,incremento=d3.event.scale,num_items=0;scaleFunc=1>incremento?d3.scale.linear().domain([1,0]).range([1,5]):d3.scale.linear().domain([2,1]).range([-5,-1]);var num_items=Math.round(scaleFunc(d3.event.scale));0>num_items&&(num_items=lngth+num_items),centerTagRepositionCourses(tagsList[num_items]),updateNodesTags(0),zoom.scale(1)}else if("zoom"==d3.event.type&&(d3.event.sourceEvent instanceof MouseEvent||d3.event.sourceEvent instanceof TouchEvent)){var lngth=tagsList.length,step=960/lngth,incremento=0;incremento=d3.event.sourceEvent instanceof MouseEvent?-d3.event.sourceEvent.movementY:previousPageY-d3.event.sourceEvent.touches[0].pageY,incremento/=30;var num_items=incremento/step;num_items=num_items>0?Math.ceil(num_items):Math.floor(num_items),0>num_items&&(num_items=lngth+num_items),centerTagRepositionCourses(tagsList[num_items]),updateNodesTags(0),d3.event.sourceEvent instanceof TouchEvent&&(previousPageY=d3.event.sourceEvent.touches[0].pageY),zoom.translate([0,0])}}function zoomScrollEndTags(){updateLinksTags(2e3)}function zoomScrollStartTags(){d3.event.sourceEvent instanceof TouchEvent&&(previousPageY=d3.event.sourceEvent.touches[0].pageY)}function createNodeCursos(){var node=courseContainer.selectAll("g.node").data(nodes);g=node.enter().append("g").attr("class",function(d){return"iscategory"in d?"node cat-"+d.slug:"node"}).attr("class",function(d){var clases=d3.select(this).attr("class");if(!("iscategory"in d)){for(var i=0;i<d.tags.length;i++)clases=clases+" tag-"+d.tagsSlug[i];clases=clases+" area-"+d.parent.slug,"emphasis"in d?clases=clases+" emphasis-"+d.emphasis:clases+=" emphasis-0"}return clases}).classed("area",function(d){return"iscategory"in d?!0:!1}).each(function(d){d.y>0&&d.iscategory&&(d.y=areaPosition),d.x>30&&d.x<150||d.x>210&&d.x<330||"iscategory"in d?d.visible=!0:d.visible=!1}),d3.selectAll("g.cat-home").each(function(d){d.visible=!1}).style("display","none"),d3.selectAll("g.emphasis-0, g.emphasis-1, g.emphasis-2, g.area").append("circle").attr("r",5),d3.selectAll("g.emphasis-3, g.emphasis-4, g.emphasis-5").append("rect").attr("x",-5).attr("y",-5).attr("width",10).attr("height",10),d3.selectAll("g.emphasis-6, g.emphasis-7, g.emphasis-8").append("path").attr("transform",function(d){return"translate(0,0)"}).attr("d",d3.svg.symbol().type("diamond")),g.append("text").attr("dy",".31em").attr("text-anchor",function(d){return textAnchor(d)}).style({opacity:0,display:"none"}).attr("transform",function(d){return"iscategory"in d?"translate(0,28)rotate("+-(d.x-90)+")":"translate(18)rotate("+-(d.x-90)+")"}).text(function(d){return d.name}),node.transition().delay(start_course_text_animation).duration(3e3).ease("elastic").style("opacity",1).attr("transform",function(d){return"rotate("+(d.x-90)+")translate("+d.y+")"}).each("end",function(d){d3.select(this).select(".area text").call(wrap,130)}),node.select("text").transition().delay(start_course_text_animation-100).duration(1500).style("opacity",function(d){return 1==d.visible?1:0}).style("display",function(d){return 1==d.visible?"inherit":"none"}),courseContainer.selectAll("g.emphasis-1, g.emphasis-4, g.emphasis-7").each(blink1),courseContainer.selectAll("g.emphasis-2, g.emphasis-5, g.emphasis-8").each(scale1)}function updateCoursesWithRotation(nn,transitionLength){setAreasPosition(),void 0===nn&&(nn=0),void 0===transitionLength&&(transitionLength=300),nodeSelection=courseContainer.selectAll("g.node").each(function(d){d.x=d.x+nn,d.x=normAngle(d.x),d.x>30&&d.x<150||d.x>210&&d.x<330||"iscategory"in d?d.visible=!0:d.visible=!1}).style("display","none"),nodeSelection.filter(function(d,i){return 1==d.iscategory?!0:"todos"==filtroTiempo?!0:"ahora"==filtroTiempo?d.proximo:"futuro"==filtroTiempo?!d.proximo:void 0}).style("display","inherit"),nodeSelection.transition().duration(transitionLength).attr("transform",function(d){return"rotate("+normAngle(d.x-90)+") translate("+d.y+")"}),nodeSelection.select("text").attr("text-anchor",function(d){return textAnchor(d)}).transition().duration(transitionLength).style("opacity",function(d){return 1==d.visible?1:0}).attr("transform",function(d){return"iscategory"in d?"translate(0,28)rotate("+-(d.x-90)+")":"translate(18)rotate("+-(d.x-90)+")"}).style("display",function(d){return 1==d.visible?"inherit":"none"})}function search(mstring){mode="search",mstring=mstring.toLowerCase(),mstring=removeDiacritics(mstring);var no=[];""==mstring?(courseContainer.selectAll("g.node:not(.area)").transition().each(function(d){return textAnchor(d)}),updateCoursesWithRotation()):(filtered=courseContainer.selectAll("g.node:not(.area)").filter(function(d){return-1==d.searchable.indexOf(mstring)?!1:!0}).each(function(d){no.push(d),d.visible=!0}),repositionNodesCC(no),updateNodeCursosCCMode()),updateLinksAreasCursos(),updateLinksTags()}function updateLinksAreasCursos(transition_length,delay1,easing){void 0===transition_length&&(transition_length=1e3),void 0===delay1&&(delay1=0),void 0===easing&&(easing="cubic-in-out"),link=courseLinkContainer.selectAll("path.link").data(cluster.links(nodes)),link.enter().append("path").attr("class","link").attr("class",function(d){return d3.select(this).attr("class")+" source-"+d.source.slug+" target-"+d.target.slug}).attr("d","M0,0"),link.classed("areacentric",function(){return"areacentric"==mode?!1:!1}).transition().delay(delay1).ease(easing).duration(transition_length).attr("d",diagonal)}function updateNodeCursosCCMode(focusCourse){var nodeSelection=courseContainer.selectAll("g.node:not(.area)");if(nodeSelection.select("text").transition().duration(2e3).style("opacity",function(d){return 1==d.visible?1:0}).style("display",function(d){return 1==d.visible?"inherit":"none"}).attr("text-anchor",function(d){return textAnchor(d)}).attr("transform",function(d){return"iscategory"in d?"translate(0,28)rotate("+-(d.x-90)+")":"translate(18)rotate("+-(d.x-90)+")"}),nodeSelection.transition().duration(2e3).attr("transform",function(d){return"rotate("+normAngle(d.x-90)+")translate("+d.y+")"}),void 0!==focusCourse){var giro=-(focusCourse.parent.x-90);courseContainer.selectAll("g.node.area").transition().duration(1500).attr("transform",function(d){return d.x=d.x+giro,"rotate("+normAngle(d.x-90)+")translate("+d.y+")"}).select("text").attr("transform",function(d){return"translate(0,28)rotate("+normAngle(-(d.x-90))+")"}).attr("text-anchor",function(d){return textAnchor(d)}),courseContainer.select("g.node.area.cat-"+focusCourse.parent.slug).classed("relevant",!0)}}function repositionNodesCC(relatedCourses,focusCourse){var distance=360/(nodes.length-numAreas);"tagcentric"==mode&&(distance=360/(nodes.length+1-numAreas));for(var i=0;i<nodes.length;i+=1)nodes[i].CCSelected=!1;void 0!==focusCourse&&(focusCourse.visible=!0,focusCourse.CCSelected=!0,focusCourse.x=90);for(var j=0,j=0;j<relatedCourses.length;j++)relatedCourses[j].x=90+distance*(1+Math.floor(j/2))*(j%2?1:-1),relatedCourses[j].visible=!0,relatedCourses[j].CCSelected=!0;var offset=relatedCourses.length,i=0,ccselectedFalse=0,ccselectedTrue=0,areaCounter=0;for("tagcentric"==mode&&(offset+=1),i=0;i<nodes.length;i++)if(1!=nodes[i].iscategory){var currentCourse=nodes[i];0==currentCourse.CCSelected?(currentCourse.x=90+distance*Math.ceil(offset/2)+(i-areaCounter)*distance,currentCourse.visible=!1,ccselectedFalse+=1):(areaCounter++,ccselectedTrue+=1)}else areaCounter++}function setAreasPosition(){courseContainer.selectAll("g.node.area").each(function(d){d.y>0&&(d.y=areaPosition)}).classed("zoomArea",function(){return"areacentric"==mode?!0:!1})}function asignTagPosition(){for(var lngth=tagsList.length,dist=360/lngth,count=0,jj=0;jj<tagsList.length;jj++){var t=tagsList[jj];t.x=count,t.y=tagRadius,tagsList[jj].order=jj,count+=dist}}function updateNodesTags(transition_length,delay1){void 0===transition_length&&(transition_length=1500),void 0===delay1&&(delay1=0);var tagsElements=tagContainer.selectAll("g.tag").data(tagsList,function(d){return d.slug}),g=tagsElements.enter().append("g").attr("class",function(d){return"tag tag-"+d.slug});g.append("text").attr("dy",".31em").text(function(d){return d.name.substring(0,17)}),tagsElements.transition().delay(delay1).duration(function(d,i){return delay1>0?transition_length+10*i:transition_length}).attr("transform",function(d){return"rotate("+d.x+")translate("+d.y+")"}).style("opacity",1),tagsElements.exit().remove()}function updateTagsWithRotation(nn){tagContainer.selectAll("g.tag").attr("transform",function(d){return d.x=d.x+nn,"rotate("+d.x+")translate("+d.y+")"})}function updateLinksTags(transition_length,delay1){"mobile"!=viewmode&&(void 0===transition_length&&(transition_length=5e3),void 0===delay1&&(delay1=250),link=tagLinkContainer.selectAll("path.linktag").data(linksTags),link.enter().append("path").attr("d","M 0,0 L 1,1").classed("linktag",!0).attr("class",function(d){return d3.select(this).attr("class")+" course-"+d.course.slug}).attr("class",function(d){return d3.select(this).attr("class")+" tag-"+d.tag.slug}),link.transition().delay(delay1).duration(transition_length).ease("elastic").attr("d",function(d){var ang1=(d.course.x-90)*(Math.PI/180),rad1=d.course.y,ang2=d.tag.x*(Math.PI/180),rad2=d.tag.y;return"M"+rad2*Math.cos(ang2)+","+rad2*Math.sin(ang2)+" L "+rad1*Math.cos(ang1)+","+rad1*Math.sin(ang1)}))}function reOrderTagsCC(course){for(var _tags=course.tagsSlug,i=(tagsList.length,0);i<_tags.length;i++)tagContainer.select("g.tag.tag-"+_tags[i]).classed("relevantCC",!0).each(function(d){tagsList.splice(d.order,1),i%2==0?tagsList.unshift(d):tagsList.push(d);for(var jj=0;jj<tagsList.length;jj++)tagsList[jj].order=jj});asignTagPosition()}function updateSelectedLinksTagsCC(course){for(var _tags=course.tags,i=0;i<_tags.length;i++)link=tagLinkContainer.selectAll("path.linktag.tag-"+_tags[i]).classed("selectedCC",!0)}function centerTagRepositionCourses(focusTag){var newList=tagsList.splice(0,focusTag.order);tagsList=tagsList.concat(newList),asignTagPosition()}function normAngle(angle){return angle%=360,angle=(angle+360)%360}function wrap(text,width){text.each(function(){for(var word,text=d3.select(this),words=text.text().split(/\s+/).reverse(),line=[],lineNumber=0,lineHeight=.6,y=text.attr("y"),dy=parseFloat(text.attr("dy")),tspan=text.text(null).append("tspan").attr("x",0).attr("y",y).attr("dy",dy+"em");word=words.pop();)line.push(word),tspan.text(line.join(" ")),tspan.node().getComputedTextLength()>width&&(line.pop(),tspan.text(line.join(" ")),line=[word],tspan=text.append("tspan").attr("x",0).attr("y",y).attr("dy",++lineNumber*lineHeight+dy+"em").text(word))})}function showHelpCircles(){var h1=helphoverContainer.append("g").classed("helpCoursesCircle",!0);initHelpTransition&&(helphoverContainer.style("display","inherit"),h1.transition().delay(change_text_help2).duration(1e3).style("opacity",1),"mobile"==viewmode&&($("#help-messages").show(),d3.select("#help-messages").transition().delay(change_text_help3+2e3).style("opacity",0).style("display","none"))),h1.append("circle").attr("cx",0).attr("cx",0).attr("r",canvasWidth/2),h1.append("text").attr("text-anchor","start").attr("dx",tagRadius+tagRadiusWeight+20).text(" Cursos"),h1=svg.append("g").classed("helpTagsCircle",!0),initHelpTransition&&(h1.transition().delay(change_text_help3).duration(1e3).style("opacity",1).style("display","inherit"),h1.transition().delay(change_text_help3+2e3).duration(1e3).style("opacity",0),h1.transition().delay(change_text_help3+3e3).style("display","none")),h1.append("circle").attr("cx",0).attr("cx",0).attr("r",tagRadius+tagRadiusWeight),h1.append("text").attr("text-anchor","start").attr("dx",tagRadius).text("Tags"),h1=helphoverContainer.append("g").classed("helpAreaCircle",!0),h1.append("circle").attr("cx",0).attr("cx",0).attr("r",tagRadius-20),h1.append("text").attr("text-anchor","middle").text("Áreas de conocimiento").transition().delay(1e3).duration(1e3).style("opacity",1),h1.append("text").attr("text-anchor","middle").classed("minitexto",!0).attr("dy",-90).text("Este es el catálogo de cursos online de la UNED"),h1.append("text").attr("text-anchor","middle").classed("minitexto",!0).attr("dy",-60).text("Explora y encuentra los que te interesen seleccionando:"),h1.append("text").attr("text-anchor","middle").classed("minitexto2",!0).attr("dy",60).text("Elige un curso, área o tag, para ver todos los cursos relacionados con él"),h1.append("text").attr("text-anchor","middle").classed("minitexto2",!0).attr("dy",100).text("Visita la página de un curso para inscribirte.")}function cookieCheckTransition(){var HOWMANYTIMESBEFORENOTSHOWINGTRANSITION=3,ntimes=Cookies.get("counter");return ntimes=void 0===ntimes?0:Number(ntimes),Cookies.set("counter",ntimes+1,{expires:365}),ntimes>HOWMANYTIMESBEFORENOTSHOWINGTRANSITION?!1:!0}function cleanTagSelections(){svg.selectAll("g.tag.selectedTagCentric").classed("selectedTagCentric",!1),svg.selectAll("g.tag.relevant").classed("relevant",!1),svg.selectAll("g.tag.relevantCC").classed("relevantCC",!1),svg.selectAll("path.linktag.selectedCC").classed("selectedCC",!1),svg.selectAll(".areacentricSelected").classed("areacentricSelected",!1),d3.select(".node.cursocentrico").classed("cursocentrico",!1),d3.select(".node.area.relevant").classed("relevant",!1),d3.select("g.cat-home").style("opacity",1)}function preprocessJson(root){jQuery.each(root.cursos,function(i,val){val.name=val.titulo,val.searchable=removeDiacritics(val.titulo).toLowerCase();var searchableTags="";for(val.tags=val.tags.split(","),i=0;i<val.tags.length;i++)val.tags[i].length<=2&&val.tags.splice(i,1);for(val.tagsSlug=[],i=0;i<val.tags.length;i++)val.tags[i]=val.tags[i].replace(/\s+/g,""),val.tagsSlug[i]=val.tags[i].replace(/[^A-Z0-9]+/gi,"_"),searchableTags+=" "+val.tags[i];val.searchable=removeDiacritics(val.titulo+searchableTags).toLowerCase();var fecha=val.fecha_inicio;0==fecha||void 0===fecha?val.proximo=!1:val.proximo=cursoProximoOActual(fecha),void 0===val.very_short_title||(0==val.very_short_title?val.slug=val.titulo.replace(/[^A-Z0-9]+/gi,"_"):val.slug=val.very_short_title.replace(/[^A-Z0-9]+/gi,"_")+val.titulo.length,val.CCSelected=!1)});var newRoot={name:"Home",iscategory:!0,slug:"home",children:[{name:"Idiomas",iscategory:!0,slug:"idiomas",children:JSON.search(root.cursos,'//*[categoria="Idiomas"]')},{name:"Psicología y Servicios Sociales",iscategory:!0,slug:"psico",children:JSON.search(root.cursos,'//*[categoria="Psicología y Servicios Sociales"]')},{name:"Educación",iscategory:!0,slug:"edu",children:JSON.search(root.cursos,'//*[categoria="Educación"]')},{name:"Ciencias y Tecnología",iscategory:!0,slug:"ciencia",children:JSON.search(root.cursos,'//*[categoria="Ciencias y Tecnología"]')},{name:"Economía y Empresa",iscategory:!0,slug:"economia",children:JSON.search(root.cursos,'//*[categoria="Economía y Empresa"]')},{name:"Derecho",iscategory:!0,slug:"derecho",children:JSON.search(root.cursos,'//*[categoria="Derecho"]')},{name:"Humanidades",iscategory:!0,slug:"humanidades",children:JSON.search(root.cursos,'//*[categoria="Humanidades"]')}]};return numAreas=8,newRoot}function getRelatedCoursesCC(course){for(var relatedCourses1=[],relatedCoursesSlug=[],i=0;i<course.tags.length;i+=1){var _tag=course.tags[i],cursostags=svg.selectAll(".node.tag-"+_tag);cursostags.each(function(d){d!=course&&-1==relatedCoursesSlug.indexOf(d.slug)&&(relatedCourses1.push(d),relatedCoursesSlug.push(d.slug))})}return relatedCourses1}function getRelatedCoursesTC(focusTag){var relatedCourses=[];return d3.selectAll("g.node.tag-"+focusTag.slug).each(function(d){relatedCourses.push(d)}),relatedCourses}function removeDiacritics(str){return str.replace(/[^\u0000-\u007E]/g,function(a){return diacriticsMap[a]||a})}function textAnchor(d){return"iscategory"in d?"middle":d.x>180?"end":"start"}function randomIntFromInterval(min,max){return Math.floor(Math.random()*(max-min+1)+min)}function cursoProximoOActual(d1){var dat2=d1.split("/"),myDate=new Date(parseInt(dat2[2])+2e3,dat2[1]-1,dat2[0]),today=new Date;return today.setDate(today.getDate()+30),today>myDate?!0:!1}var start_course_animation=2e3,change_text_help2=4e3,start_course_text_animation=4500,change_text_help3=7e3,start_tags_animation=6700,viewmode,viewmode_sub,viewportWidth,viewportHeight,availableHeight,canvasWidth,diameter,canvasHeight,radius,clusterSize,leftOffset,translatePositionX,translatePositionY,tagRadiusWeight,tagRadius,areaPosition,initHelpTransition,filename="UA-ListadoIEDRA2015-16.json";setSizes();var timerRotateCourses=null,timerAutoRotate=null,cluster,svg,link,nodes,tagsDict,tagsList,linksTags,mode="zoomout",numAreas=0,tagContainer,tagLinkContainer,courseContainer,courseLinkContainer,backgroundContainer,myZoom=1,myTranslate=[0,0],filtroTiempo="todos";$(document).ready(function(){initHelpTransition=cookieCheckTransition(),doeverything(),$(window).on("orientationchange",function(){setTimeout(reload,100)}),$("#course-center").on("click",function(e){e.preventDefault();var _course=$(this).data("courseObject"),_coursedom=$(this).data("courseNode");"mobile"==viewmode&&$("#messages").fadeOut(),cursoCentric(_course,_coursedom)}),$("#move-left a").on("click",function(e){e.preventDefault(),myTranslate[0]=50,myTranslate[1]=translatePositionY,svg.transition().duration(1e3).attr("transform","translate("+myTranslate+")"),$("#move-left").hide()}),$("#move-up a").on("touchstart",function(e){e.preventDefault(),null!=timerRotateCourses&&clearTimeout(timerRotateCourses),autoRotateCoursesUP()}),$("#move-down a").on("touchstart",function(e){e.preventDefault(),null!=timerRotateCourses&&clearTimeout(timerRotateCourses),autoRotateCoursesDOWN()}),$("#move-up a, #move-down a").on("touchend",function(e){e.preventDefault(),clearTimeout(timerRotateCourses),timerRotateCourses=null}),$("#tag-list").on("click","a",function(e){e.preventDefault();var myTag=$(this).data("tag");tagCentric(tagsDict[myTag],$("g.tag.tag-"+tagsDict[myTag].slug)[0]),"mobile"==viewmode&&$("#messages").fadeOut()}),$(".help-btn").on("click",function(e){if(e.preventDefault(),$(this).toggleClass("checked"),$(this).hasClass("checked")){var p=$(".helphoverContainer").detach();p.insertAfter(".courseContainer"),p=$(".helpTagsCircle").detach(),p.insertAfter(".helpCoursesCircle"),$(".helphoverContainer").fadeIn(),$(".helpCoursesCircle").fadeIn(),$(".helpCoursesCircle").css("opacity",1),$(".helpAreaCircle").fadeIn(),$(".helpTagsCircle").css("opacity",1),$(".helpTagsCircle").fadeIn(),$(".helpTagsCircle circle").fadeIn(),$(".helpTagsCircle text, .helpAreaCircle text:not(.minitexto, .minitexto2), .helpCoursesCircle text").css("fill","#F0AD4E"),$(".minitexto2").fadeIn(),"mobile"==viewmode&&($("#help-messages").show(),$("#help-messages").css("opacity",1),$(".helpAreaCircle").hide())}else $(".helphoverContainer").fadeOut(),"mobile"==viewmode&&$("#help-messages").hide()}),$(".helphoverContainer").on("click",function(e){e.preventDefault(),$("#help-btn").toggleClass("checked"),$(".helphoverContainer").fadeOut()}),$("a#category-list").on("click",function(e){e.preventDefault();var cat=$(this).data("category");areaCentric(cat),"mobile"==viewmode&&$("#messages").fadeOut()}),$("#search").keyup(function(event){var term=(event.which,$(this).val());$("input:radio[name=tiempo]").prop("checked",!1),$("input#inlineCheckbox3").prop("checked",!0),filtroTiempo="todos",term.length>1?(search(term),"mobile"==viewmode&&$("#messages").fadeOut()):search(""),13==event.keyCode&&$(this).blur()}),$("select").on("change",function(){$("option:selected",this);valueSelected=this.value,$("#search").val(""),courseContainer.select(".area.cat-"+valueSelected).each(function(d){areaCentric(d)})}),$("input:radio[name=tiempo]").change(function(){$("#search").val(""),"todos"==this.value?filtroTiempo="todos":"ahora"==this.value?filtroTiempo="ahora":"futuro"==this.value&&(filtroTiempo="futuro"),updateCoursesWithRotation(void 0,1500)}),$(document).keypress(function(event){})});for(var zoomCursos=d3.behavior.zoom().on("zoom",zoomScrollCursos).on("zoomend",zoomScrollCursosEnd).on("zoomstart",zoomScrollCursosStart),zoom=d3.behavior.zoom().on("zoom",zoomScrollTags).on("zoomend",zoomScrollEndTags).on("zoomstart",zoomScrollStartTags),linkNodeTag=function(mtagsDict,mnodes){var _linksTags=[];return jQuery.each(mnodes,function(i,curso){
if(1==curso.iscategory)return-1;for(i=0;i<curso.tags.length;i++)_linksTags.push({course:curso,tag:mtagsDict[curso.tags[i]]})}),_linksTags},diagonal=d3.svg.diagonal.radial().projection(function(d){return[d.y,d.x/180*Math.PI]}),getTags=function(root){var mtags={},tagsHelper=[],tagList1=[];return jQuery.each(root.cursos,function(i,curso){jQuery.each(curso.tags,function(i,tag){var found=jQuery.inArray(tag,tagsHelper);-1==found&&(tagsHelper.push(tag),mtags[tag]={x:0,y:0,order:1,name:tag,slug:tag.replace(/[^A-Z0-9]+/gi,"_")},tagList1.push(mtags[tag]))})}),{diccio:mtags,arr:tagList1}},defaultDiacriticsRemovalap=[{base:"A",letters:"AⒶＡÀÁÂẦẤẪẨÃĀĂẰẮẴẲȦǠÄǞẢÅǺǍȀȂẠẬẶḀĄȺⱯ"},{base:"AA",letters:"Ꜳ"},{base:"AE",letters:"ÆǼǢ"},{base:"AO",letters:"Ꜵ"},{base:"AU",letters:"Ꜷ"},{base:"AV",letters:"ꜸꜺ"},{base:"AY",letters:"Ꜽ"},{base:"B",letters:"BⒷＢḂḄḆɃƂƁ"},{base:"C",letters:"CⒸＣĆĈĊČÇḈƇȻꜾ"},{base:"D",letters:"DⒹＤḊĎḌḐḒḎĐƋƊƉꝹ"},{base:"DZ",letters:"ǱǄ"},{base:"Dz",letters:"ǲǅ"},{base:"E",letters:"EⒺＥÈÉÊỀẾỄỂẼĒḔḖĔĖËẺĚȄȆẸỆȨḜĘḘḚƐƎ"},{base:"F",letters:"FⒻＦḞƑꝻ"},{base:"G",letters:"GⒼＧǴĜḠĞĠǦĢǤƓꞠꝽꝾ"},{base:"H",letters:"HⒽＨĤḢḦȞḤḨḪĦⱧⱵꞍ"},{base:"I",letters:"IⒾＩÌÍÎĨĪĬİÏḮỈǏȈȊỊĮḬƗ"},{base:"J",letters:"JⒿＪĴɈ"},{base:"K",letters:"KⓀＫḰǨḲĶḴƘⱩꝀꝂꝄꞢ"},{base:"L",letters:"LⓁＬĿĹĽḶḸĻḼḺŁȽⱢⱠꝈꝆꞀ"},{base:"LJ",letters:"Ǉ"},{base:"Lj",letters:"ǈ"},{base:"M",letters:"MⓂＭḾṀṂⱮƜ"},{base:"N",letters:"NⓃＮǸŃÑṄŇṆŅṊṈȠƝꞐꞤ"},{base:"NJ",letters:"Ǌ"},{base:"Nj",letters:"ǋ"},{base:"O",letters:"OⓄＯÒÓÔỒỐỖỔÕṌȬṎŌṐṒŎȮȰÖȪỎŐǑȌȎƠỜỚỠỞỢỌỘǪǬØǾƆƟꝊꝌ"},{base:"OI",letters:"Ƣ"},{base:"OO",letters:"Ꝏ"},{base:"OU",letters:"Ȣ"},{base:"OE",letters:"Œ"},{base:"oe",letters:"œ"},{base:"P",letters:"PⓅＰṔṖƤⱣꝐꝒꝔ"},{base:"Q",letters:"QⓆＱꝖꝘɊ"},{base:"R",letters:"RⓇＲŔṘŘȐȒṚṜŖṞɌⱤꝚꞦꞂ"},{base:"S",letters:"SⓈＳẞŚṤŜṠŠṦṢṨȘŞⱾꞨꞄ"},{base:"T",letters:"TⓉＴṪŤṬȚŢṰṮŦƬƮȾꞆ"},{base:"TZ",letters:"Ꜩ"},{base:"U",letters:"UⓊＵÙÚÛŨṸŪṺŬÜǛǗǕǙỦŮŰǓȔȖƯỪỨỮỬỰỤṲŲṶṴɄ"},{base:"V",letters:"VⓋＶṼṾƲꝞɅ"},{base:"VY",letters:"Ꝡ"},{base:"W",letters:"WⓌＷẀẂŴẆẄẈⱲ"},{base:"X",letters:"XⓍＸẊẌ"},{base:"Y",letters:"YⓎＹỲÝŶỸȲẎŸỶỴƳɎỾ"},{base:"Z",letters:"ZⓏＺŹẐŻŽẒẔƵȤⱿⱫꝢ"},{base:"a",letters:"aⓐａẚàáâầấẫẩãāăằắẵẳȧǡäǟảåǻǎȁȃạậặḁąⱥɐ"},{base:"aa",letters:"ꜳ"},{base:"ae",letters:"æǽǣ"},{base:"ao",letters:"ꜵ"},{base:"au",letters:"ꜷ"},{base:"av",letters:"ꜹꜻ"},{base:"ay",letters:"ꜽ"},{base:"b",letters:"bⓑｂḃḅḇƀƃɓ"},{base:"c",letters:"cⓒｃćĉċčçḉƈȼꜿↄ"},{base:"d",letters:"dⓓｄḋďḍḑḓḏđƌɖɗꝺ"},{base:"dz",letters:"ǳǆ"},{base:"e",letters:"eⓔｅèéêềếễểẽēḕḗĕėëẻěȅȇẹệȩḝęḙḛɇɛǝ"},{base:"f",letters:"fⓕｆḟƒꝼ"},{base:"g",letters:"gⓖｇǵĝḡğġǧģǥɠꞡᵹꝿ"},{base:"h",letters:"hⓗｈĥḣḧȟḥḩḫẖħⱨⱶɥ"},{base:"hv",letters:"ƕ"},{base:"i",letters:"iⓘｉìíîĩīĭïḯỉǐȉȋịįḭɨı"},{base:"j",letters:"jⓙｊĵǰɉ"},{base:"k",letters:"kⓚｋḱǩḳķḵƙⱪꝁꝃꝅꞣ"},{base:"l",letters:"lⓛｌŀĺľḷḹļḽḻſłƚɫⱡꝉꞁꝇ"},{base:"lj",letters:"ǉ"},{base:"m",letters:"mⓜｍḿṁṃɱɯ"},{base:"n",letters:"nⓝｎǹńñṅňṇņṋṉƞɲŉꞑꞥ"},{base:"nj",letters:"ǌ"},{base:"o",letters:"oⓞｏòóôồốỗổõṍȭṏōṑṓŏȯȱöȫỏőǒȍȏơờớỡởợọộǫǭøǿɔꝋꝍɵ"},{base:"oi",letters:"ƣ"},{base:"ou",letters:"ȣ"},{base:"oo",letters:"ꝏ"},{base:"p",letters:"pⓟｐṕṗƥᵽꝑꝓꝕ"},{base:"q",letters:"qⓠｑɋꝗꝙ"},{base:"r",letters:"rⓡｒŕṙřȑȓṛṝŗṟɍɽꝛꞧꞃ"},{base:"s",letters:"sⓢｓßśṥŝṡšṧṣṩșşȿꞩꞅẛ"},{base:"t",letters:"tⓣｔṫẗťṭțţṱṯŧƭʈⱦꞇ"},{base:"tz",letters:"ꜩ"},{base:"u",letters:"uⓤｕùúûũṹūṻŭüǜǘǖǚủůűǔȕȗưừứữửựụṳųṷṵʉ"},{base:"v",letters:"vⓥｖṽṿʋꝟʌ"},{base:"vy",letters:"ꝡ"},{base:"w",letters:"wⓦｗẁẃŵẇẅẘẉⱳ"},{base:"x",letters:"xⓧｘẋẍ"},{base:"y",letters:"yⓨｙỳýŷỹȳẏÿỷẙỵƴɏỿ"},{base:"z",letters:"zⓩｚźẑżžẓẕƶȥɀⱬꝣ"}],diacriticsMap={},i=0;i<defaultDiacriticsRemovalap.length;i++)for(var letters=defaultDiacriticsRemovalap[i].letters,j=0;j<letters.length;j++)diacriticsMap[letters[j]]=defaultDiacriticsRemovalap[i].base;